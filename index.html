<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù†Ø®Ø¨Ø© Ø§Ù„Ù…Ø­Ø§Ø±Ø¨ÙŠÙ† - Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø£ÙÙ‚ÙŠ</title>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>
    <style>
        :root { --bg: #0d1117; --gold: #f1c40f; --shield: #3498db; --danger: #e74c3c; --panel: #161b22; --accent: #2ecc71; }
        
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: white; margin: 0; overflow: hidden; display: flex; height: 100vh; width: 100vw; }

        /* Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        aside { width: 220px; background: var(--panel); border: 1px solid #30363d; display: flex; flex-direction: column; padding: 10px; box-sizing: border-box; }
        
        main#gameArea { flex-grow: 1; position: relative; background: #010409; overflow: hidden; touch-action: none; background-image: radial-gradient(#30363d 1px, transparent 1px); background-size: 40px 40px; }

        .stat-card { background: #0d1117; padding: 12px; border-radius: 8px; margin-bottom: 10px; text-align: center; border: 1px solid #30363d; }
        .stat-card span { color: var(--gold); font-size: 1.3rem; font-weight: bold; display: block; }

        /* Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ */
        .resource { width: 45px; height: 45px; position: absolute; border-radius: 50%; background: var(--gold); box-shadow: 0 0 20px var(--gold); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; cursor: pointer; z-index: 10; transition: transform 0.1s; }

        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙˆØ§Ù„ØªØ±ØªÙŠØ¨ */
        #playersContainer { flex-grow: 1; overflow-y: auto; }
        .player-row { background: #21262d; margin-bottom: 6px; padding: 8px; border-radius: 6px; position: relative; border-right: 4px solid transparent; }
        .top-rank { border-right-color: var(--gold); }
        .rank-num { position: absolute; left: 8px; top: 50%; transform: translateY(-50%); font-weight: bold; color: var(--gold); font-size: 1.1rem; }
        .player-info { margin-right: 25px; display: flex; flex-direction: column; font-size: 0.85rem; }
        
        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn { border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .attack-btn { background: var(--danger); color: white; padding: 6px; width: 100%; margin-top: 5px; font-size: 0.8rem; }
        .shield-btn { background: var(--shield); color: white; padding: 15px; margin-top: auto; }
        .info-btn { background: transparent; color: #8b949e; border: 1px solid #30363d; margin-top: 5px; font-size: 0.7rem; padding: 4px; }

        /* Ù†ÙˆØ§ÙØ° Ø§Ù„Ø´Ø±Ø­ */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 1000; padding: 20px; }
        .modal { background: var(--panel); padding: 25px; border-radius: 12px; border: 1px solid #30363d; max-width: 400px; text-align: center; }
        .modal h2 { color: var(--gold); margin-top: 0; }
        .modal p { line-height: 1.6; color: #c9d1d9; }

        /* ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #loginOverlay { display: flex; background: var(--bg); }
        input { background: #0d1117; border: 1px solid #30363d; color: white; padding: 12px; border-radius: 6px; width: 100%; box-sizing: border-box; margin-bottom: 15px; }
    </style>
</head>
<body>

<div id="loginOverlay" class="overlay">
    <div class="modal">
        <h2>âš”ï¸ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø±Ø¨ÙŠÙ†</h2>
        <p>Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³Ø¬Ù„ Ø£Ùˆ Ø§Ø®ØªØ± Ø§Ø³Ù…Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹ Ù„ØªØ¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ.</p>
        <input type="text" id="usernameInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...">
        <button class="btn shield-btn" style="width: 100%;" onclick="initPlayer()">Ø¯Ø®ÙˆÙ„ / ØªØ³Ø¬ÙŠÙ„</button>
    </div>
</div>

<div id="gameIntro" class="overlay">
    <div class="modal">
        <h2>ğŸ® ÙƒÙŠÙ ØªÙ„Ø¹Ø¨ØŸ</h2>
        <p>Ø§Ø¬Ù…Ø¹ Ø§Ù„Ø°Ù‡Ø¨ ğŸ’° Ù…Ù† Ø§Ù„Ø³Ø§Ø­Ø© Ù„Ø²ÙŠØ§Ø¯Ø© Ø«Ø±ÙˆØªÙƒ. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°Ù‡Ø¨ Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¯Ø±ÙˆØ¹ ğŸ›¡ï¸ Ø£Ùˆ Ø§Ù„Ù‡Ø¬ÙˆÙ… Ø¹Ù„Ù‰ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ† âš”ï¸ Ù„ØªØµØ¨Ø­ Ø§Ù„Ø±Ù‚Ù… 1!</p>
        <button class="btn shield-btn" style="width: 100%;" onclick="closeModal('gameIntro')">ÙÙ‡Ù…ØªØŒ Ù„Ù†Ø¨Ø¯Ø£!</button>
    </div>
</div>

<div id="attackInfo" class="overlay">
    <div class="modal">
        <h2>âš”ï¸ Ù‚ÙˆØ§Ù†ÙŠÙ† Ø§Ù„Ù‡Ø¬ÙˆÙ…</h2>
        <p>â€¢ Ø¥Ø°Ø§ Ù‡Ø§Ø¬Ù…Øª Ø´Ø®ØµØ§Ù‹ <b>Ø£ØºÙ†Ù‰ Ù…Ù†Ùƒ</b>: Ø³ØªØ®Ø³Ø± 30 Ø¹Ù…Ù„Ø©.<br>â€¢ Ø¥Ø°Ø§ Ù‡Ø§Ø¬Ù…Øª Ø´Ø®ØµØ§Ù‹ <b>Ø£ÙÙ‚Ø± Ù…Ù†Ùƒ</b>: Ø³ØªÙ†Ù‡Ø¨ 20% Ù…Ù† Ø°Ù‡Ø¨Ù‡.<br>â€¢ Ø§Ù„Ù‡Ø¬ÙˆÙ… ÙŠØ¶Ø¹Ùƒ ÙÙŠ ÙØªØ±Ø© Ø§Ù†ØªØ¸Ø§Ø± (10 Ø¯Ù‚Ø§Ø¦Ù‚).</p>
        <button class="btn attack-btn" style="width: 100%;" onclick="closeModal('attackInfo')">Ø­Ø³Ù†Ø§Ù‹</button>
    </div>
</div>

<div id="shieldInfo" class="overlay">
    <div class="modal">
        <h2>ğŸ›¡ï¸ Ù…ÙŠØ²Ø© Ø§Ù„Ø¯Ø±Ø¹</h2>
        <p>ÙŠÙƒÙ„Ù Ø§Ù„Ø¯Ø±Ø¹ <b>100 Ø°Ù‡Ø¨</b> ÙˆÙŠÙ…Ù†Ø­Ùƒ Ø­ØµØ§Ù†Ø© ÙƒØ§Ù…Ù„Ø© Ù…Ù† Ø§Ù„Ù‡Ø¬Ù…Ø§Øª Ù„Ù…Ø¯Ø© <b>10 Ø¯Ù‚Ø§Ø¦Ù‚</b>. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù„Ø£Ø­Ø¯ Ø³Ø±Ù‚ØªÙƒ ÙˆØ£Ù†Øª Ù…Ø­Ù…ÙŠ!</p>
        <button class="btn shield-btn" style="width: 100%;" onclick="closeModal('shieldInfo')">ÙÙ‡Ù…Øª</button>
    </div>
</div>

<aside>
    <div class="stat-card">Ø°Ù‡Ø¨Ùƒ<span id="myScore">0</span></div>
    <div class="stat-card">Ø§Ù„Ø¯Ø±Ø¹<span id="shieldText">ØºÙŠØ± Ù†Ø´Ø·</span></div>
    <div class="stat-card">Ø§Ù„Ù‡Ø¬ÙˆÙ…<span id="cooldown">Ø¬Ø§Ù‡Ø²</span></div>
    <button class="btn info-btn" onclick="showModal('shieldInfo')">ØŸ Ø´Ø±Ø­ Ø§Ù„Ø¯ÙØ§Ø¹</button>
    <button class="btn shield-btn" onclick="buyShield()">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¹ ğŸ›¡ï¸</button>
</aside>

<main id="gameArea"></main>

<aside>
    <h4 style="margin: 0 0 10px 0; text-align: center;">Ø§Ù„Ù…ØªØµØ¯Ø±ÙˆÙ† ğŸ†</h4>
    <div id="playersContainer"></div>
    <button class="btn info-btn" onclick="showModal('attackInfo')">ØŸ Ø´Ø±Ø­ Ø§Ù„Ù‡Ø¬ÙˆÙ…</button>
</aside>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAbYbcjdLAEfqIPyrdHq1ZIqjqumDVjhmI",
        authDomain: "barqnet-2a561.firebaseapp.com",
        databaseURL: "https://barqnet-2a561-default-rtdb.firebaseio.com",
        projectId: "barqnet-2a561",
        storageBucket: "barqnet-2a561.firebasestorage.app",
        messagingSenderId: "53556699186",
        appId: "1:53556699186:web:c9e2b60d81979c18841c2b"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let playerName, playerRef, myLocalScore = 0, attackCooldown = 0;

    function showModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    // Ø¯Ø®ÙˆÙ„ / ØªØ³Ø¬ÙŠÙ„ Ù„Ø§Ø¹Ø¨
    function initPlayer() {
        const input = document.getElementById('usernameInput').value.trim();
        if (!input) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…!");
        playerName = input;
        playerRef = db.ref('players/' + playerName);

        playerRef.get().then(snap => {
            if (!snap.exists()) {
                // Ù„Ø§Ø¹Ø¨ Ø¬Ø¯ÙŠØ¯
                playerRef.set({ name: playerName, score: 0, shieldUntil: 0 });
            }
            closeModal('loginOverlay');
            showModal('gameIntro');
            startSync();
        });
        playerRef.onDisconnect().update({ online: false }); // ÙŠÙ…ÙƒÙ† ØªØ·ÙˆÙŠØ±Ù‡Ø§ Ù„Ù†Ø¸Ø§Ù… Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†
    }

    function startSync() {
        playerRef.on('value', snap => {
            const d = snap.val();
            if (d) {
                myLocalScore = d.score || 0;
                document.getElementById('myScore').textContent = myLocalScore;
                const now = Date.now();
                if (d.shieldUntil > now) {
                    const rem = Math.ceil((d.shieldUntil - now) / 1000);
                    document.getElementById('shieldText').textContent = Math.floor(rem/60) + ":" + (rem%60).toString().padStart(2,'0');
                } else { document.getElementById('shieldText').textContent = "ØºÙŠØ± Ù†Ø´Ø·"; }
            }
        });

        // Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
        db.ref('map').on('child_added', snap => {
            const d = snap.val();
            const res = document.createElement('div');
            res.className = 'resource'; res.id = snap.key; res.innerHTML = 'ğŸ’°';
            res.style.left = d.x + "%"; res.style.top = d.y + "%";
            res.onclick = () => {
                playerRef.child('score').transaction(s => (s || 0) + 15);
                db.ref('map/' + snap.key).remove();
            };
            document.getElementById('gameArea').appendChild(res);
        });

        db.ref('map').on('child_removed', snap => {
            const el = document.getElementById(snap.key);
            if (el) el.remove();
        });

        // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† (Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù…Ø¹ ØªØ±Ù‚ÙŠÙ… Ø£ÙˆÙ„ 5)
        db.ref('players').orderByChild('score').on('value', snap => {
            const cont = document.getElementById('playersContainer');
            cont.innerHTML = '';
            let allPlayers = [];
            snap.forEach(c => { allPlayers.push({key: c.key, ...c.val()}); });
            allPlayers.reverse();

            allPlayers.forEach((p, index) => {
                if (p.key === playerName) return;
                const rank = index + 1;
                const isS = p.shieldUntil > Date.now();
                const div = document.createElement('div');
                div.className = `player-row ${rank <= 5 ? 'top-rank' : ''}`;
                div.innerHTML = `
                    ${rank <= 5 ? `<div class="rank-num">${rank}</div>` : ''}
                    <div class="player-info">
                        <strong>${p.name || p.key}</strong>
                        <span>ğŸ’° ${p.score || 0}</span>
                    </div>
                    <button class="btn attack-btn" ${isS || attackCooldown > 0 ? 'disabled' : ''} 
                        onclick="attackPlayer('${p.key}')">${isS ? 'Ù…Ø­Ù…ÙŠ ğŸ›¡ï¸' : 'Ù‡Ø¬ÙˆÙ… âš”ï¸'}</button>
                `;
                cont.appendChild(div);
            });
        });
    }

    // Ø§Ù„Ù‡Ø¬ÙˆÙ… ÙˆØ§Ù„Ù…ÙˆÙ„Ø¯ (Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³Ø§Ø¨Ù‚)
    function attackPlayer(tName) {
        const tRef = db.ref('players/' + tName);
        tRef.get().then(snap => {
            const t = snap.val();
            if (t.shieldUntil > Date.now()) return alert("Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…Ø­Ù…ÙŠ!");
            if (t.score > myLocalScore) {
                playerRef.child('score').transaction(s => Math.max(0, s - 30));
                tRef.child('score').transaction(s => (s || 0) + 30);
                alert("Ø®Ø³Ø±Øª Ø§Ù„Ù‡Ø¬ÙˆÙ…!");
            } else {
                const loot = Math.floor(t.score * 0.2);
                playerRef.child('score').transaction(s => (s || 0) + loot);
                tRef.child('score').transaction(s => Math.max(0, s - loot));
                alert("Ù†Ù‡Ø¨Øª Ø§Ù„Ø°Ù‡Ø¨!");
            }
            attackCooldown = 600; startCooldown();
        });
    }

    function startCooldown() {
        const itv = setInterval(() => {
            if (attackCooldown > 0) {
                attackCooldown--;
                document.getElementById('cooldown').textContent = Math.floor(attackCooldown/60) + ":" + (attackCooldown%60).toString().padStart(2,'0');
            } else { document.getElementById('cooldown').textContent = "Ø¬Ø§Ù‡Ø²"; clearInterval(itv); }
        }, 1000);
    }

    function buyShield() {
        if (myLocalScore >= 100) {
            playerRef.child('score').transaction(s => s - 100);
            playerRef.child('shieldUntil').set(Date.now() + 600000);
        } else { alert("ØªØ­ØªØ§Ø¬ 100 Ø°Ù‡Ø¨!"); }
    }

    setInterval(() => {
        db.ref('map').once('value', snap => {
            if (snap.numChildren() < 10) db.ref('map').push({ x: Math.random()*90+5, y: Math.random()*85+5 });
        });
    }, 4000);
</script>
</body>
</html>
