<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø­Ø±Ø¨ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© âš”ï¸</title>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>
    <style>
        :root { --bg: #1a1a2e; --gold: #f1c40f; --shield: #3498db; --danger: #e74c3c; }
        body { font-family: sans-serif; background: var(--bg); color: white; margin: 0; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        header { background: #16213e; padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; border-bottom: 2px solid #0f3460; }
        .stat { background: #0f3460; padding: 5px; border-radius: 5px; text-align: center; font-size: 0.8rem; }
        .stat span { color: var(--gold); display: block; font-size: 1rem; font-weight: bold; }
        #gameArea { flex-grow: 1; position: relative; background: #1b262c; touch-action: none; overflow: hidden; }
        .resource { width: 40px; height: 40px; position: absolute; border-radius: 50%; background: var(--gold); box-shadow: 0 0 15px var(--gold); display: flex; align-items: center; justify-content: center; animation: pop 0.3s ease; font-size: 1.4rem; cursor: pointer; z-index: 10; }
        @keyframes pop { from { transform: scale(0); } to { transform: scale(1); } }
        #leaderboard { background: #16213e; max-height: 180px; overflow-y: auto; padding: 10px; font-size: 0.85rem; border-top: 2px solid #0f3460; }
        .player-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #0f3460; align-items: center; }
        .attack-btn { background: var(--danger); color: white; border: none; padding: 6px 12px; border-radius: 5px; font-weight: bold; }
        .attack-btn:disabled { background: #444; color: #888; }
        footer { padding: 12px; background: #16213e; text-align: center; }
        .shield-btn { background: var(--shield); color: white; border: none; padding: 12px; border-radius: 25px; width: 90%; font-weight: bold; font-size: 1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .shield-btn:active { transform: scale(0.98); }
    </style>
</head>
<body>

<header>
    <div class="stat">Ø°Ù‡Ø¨Ùƒ<span id="myScore">0</span></div>
    <div class="stat">Ø§Ù„Ù‡Ø¬ÙˆÙ… Ø§Ù„Ù‚Ø§Ø¯Ù…<span id="cooldown">Ø¬Ø§Ù‡Ø²</span></div>
    <div class="stat" style="grid-column: span 2;">Ø§Ù„Ø¯Ø±Ø¹<span id="shieldText">ØºÙŠØ± Ù†Ø´Ø·</span></div>
</header>

<div id="gameArea"></div>

<div id="leaderboard">
    <strong style="display: block; margin-bottom: 5px; color: #aaa;">Ø£Ù‚ÙˆÙ‰ 10 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„Ø¢Ù†:</strong>
    <div id="playersContainer"></div>
</div>

<footer>
    <button class="shield-btn" onclick="buyShield()">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¹ (100 Ø°Ù‡Ø¨) ğŸ›¡ï¸</button>
</footer>

<script>
    // 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyAbYbcjdLAEfqIPyrdHq1ZIqjqumDVjhmI",
        authDomain: "barqnet-2a561.firebaseapp.com",
        databaseURL: "https://barqnet-2a561-default-rtdb.firebaseio.com",
        projectId: "barqnet-2a561",
        storageBucket: "barqnet-2a561.firebasestorage.app",
        messagingSenderId: "53556699186",
        appId: "1:53556699186:web:c9e2b60d81979c18841c2b",
        measurementId: "G-CNHL8MX90W"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 2. ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù„Ø§Ø¹Ø¨
    const playerName = prompt("Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±:") || "Ù„Ø§Ø¹Ø¨_" + Math.floor(Math.random()*1000);
    const playerRef = db.ref('players/' + playerName);
    let myLocalScore = 0;
    let attackCooldown = 0;

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨
    playerRef.set({
        name: playerName,
        score: 0,
        shieldUntil: 0
    });
    playerRef.onDisconnect().remove();

    // 3. Ù…Ø²Ø§Ù…Ù†Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙŠ
    playerRef.on('value', snap => {
        const data = snap.val();
        if (data) {
            myLocalScore = data.score || 0;
            document.getElementById('myScore').textContent = myLocalScore;
            
            const now = Date.now();
            if (data.shieldUntil && data.shieldUntil > now) {
                const remaining = Math.ceil((data.shieldUntil - now) / 1000);
                document.getElementById('shieldText').textContent = Math.floor(remaining/60) + ":" + (remaining%60).toString().padStart(2,'0');
            } else {
                document.getElementById('shieldText').textContent = "ØºÙŠØ± Ù†Ø´Ø·";
            }
        }
    });

    // 4. Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ (Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©)
    db.ref('map').on('child_added', snap => {
        const resData = snap.val();
        const resDiv = document.createElement('div');
        resDiv.className = 'resource';
        resDiv.id = snap.key;
        resDiv.innerHTML = 'ğŸ’°';
        resDiv.style.left = resData.x + "%";
        resDiv.style.top = resData.y + "%";
        
        resDiv.onclick = (e) => {
            e.stopPropagation();
            playerRef.child('score').transaction(s => (s || 0) + 15);
            db.ref('map/' + snap.key).remove();
        };
        document.getElementById('gameArea').appendChild(resDiv);
    });

    db.ref('map').on('child_removed', snap => {
        const el = document.getElementById(snap.key);
        if (el) el.remove();
    });

    // Ù…ÙˆÙ„Ø¯ Ù…ÙˆØ§Ø±Ø¯ Ø¨Ø³ÙŠØ· Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± (ÙŠØ¹Ù…Ù„ Ø¹Ù†Ø¯ Ø´Ø®Øµ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¶ØºØ·)
    setInterval(() => {
        db.ref('map').once('value', snap => {
            if (snap.numChildren() < 8) {
                db.ref('map').push({
                    x: Math.random() * 85 + 5,
                    y: Math.random() * 85 + 5
                });
            }
        });
    }, 4000);

    // 5. Ù†Ø¸Ø§Ù… Ø§Ù„Ù‡Ø¬ÙˆÙ…
    function attackPlayer(targetName) {
        if (attackCooldown > 0) return alert("ÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨Ù„ Ø§Ù„Ù‡Ø¬ÙˆÙ… Ù…Ø¬Ø¯Ø¯Ø§Ù‹!");
        if (targetName === playerName) return;

        const targetRef = db.ref('players/' + targetName);
        targetRef.get().then(snap => {
            const target = snap.val();
            if (!target) return;

            const now = Date.now();
            if (target.shieldUntil && target.shieldUntil > now) return alert("Ù‡Ø°Ø§ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…Ø­Ù…ÙŠ Ø¨Ø§Ù„Ø¯Ø±Ø¹!");

            if (target.score > myLocalScore) {
                // Ø®Ø³Ø§Ø±Ø© ÙÙŠ Ø§Ù„Ù‡Ø¬ÙˆÙ…
                playerRef.child('score').transaction(s => Math.max(0, (s || 0) - 30));
                targetRef.child('score').transaction(s => (s || 0) + 30);
                alert(`Ù‡Ø²ÙŠÙ…Ø©! ${targetName} Ø£Ù‚ÙˆÙ‰ Ù…Ù†Ùƒ. Ø®Ø³Ø±Øª 30 Ø°Ù‡Ø¨.`);
            } else {
                // ÙÙˆØ² ÙÙŠ Ø§Ù„Ù‡Ø¬ÙˆÙ…
                const loot = Math.floor((target.score || 0) * 0.2);
                playerRef.child('score').transaction(s => (s || 0) + loot);
                targetRef.child('score').transaction(s => Math.max(0, (s || 0) - loot));
                alert(`Ù†ØµØ±! Ù†Ù‡Ø¨Øª ${loot} Ø°Ù‡Ø¨ Ù…Ù† ${targetName}.`);
            }
            
            attackCooldown = 600; // 10 Ø¯Ù‚Ø§Ø¦Ù‚
            startCooldownTimer();
        });
    }

    function startCooldownTimer() {
        const timer = setInterval(() => {
            if (attackCooldown > 0) {
                attackCooldown--;
                const m = Math.floor(attackCooldown/60);
                const s = attackCooldown%60;
                document.getElementById('cooldown').textContent = `${m}:${s < 10 ? '0' : ''}${s}`;
            } else {
                document.getElementById('cooldown').textContent = "Ø¬Ø§Ù‡Ø²";
                clearInterval(timer);
            }
        }, 1000);
    }

    function buyShield() {
        if (myLocalScore >= 100) {
            playerRef.child('score').transaction(s => (s || 0) - 100);
            playerRef.child('shieldUntil').set(Date.now() + 600000);
            alert("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¹ Ù„Ù€ 10 Ø¯Ù‚Ø§Ø¦Ù‚! ğŸ›¡ï¸");
        } else {
            alert("ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ 100 Ø°Ù‡Ø¨ Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¹!");
        }
    }

    // 6. ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† (Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© undefined)
    db.ref('players').orderByChild('score').limitToLast(10).on('value', snap => {
        const container = document.getElementById('playersContainer');
        container.innerHTML = '';
        const playersList = [];

        snap.forEach(child => {
            const data = child.val();
            // Ø¥ØµÙ„Ø§Ø­: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù…Ø®Ø²Ù† Ø£Ùˆ Ù…ÙØªØ§Ø­ Ø§Ù„Ø¹Ù‚Ø¯Ø© ÙƒØ§Ø­ØªÙŠØ§Ø·
            const nameToDisplay = data.name || child.key;
            playersList.push({ ...data, name: nameToDisplay });
        });

        // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£ØºÙ†Ù‰ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
        playersList.reverse().forEach(p => {
            if (p.name === playerName) return;

            const isShielded = p.shieldUntil && p.shieldUntil > Date.now();
            const div = document.createElement('div');
            div.className = 'player-row';
            div.innerHTML = `
                <span>ğŸ‘¤ ${p.name} (ğŸ’°${p.score || 0}) ${isShielded ? 'ğŸ›¡ï¸' : ''}</span>
                <button class="attack-btn" ${isShielded || attackCooldown > 0 ? 'disabled' : ''} 
                    onclick="attackPlayer('${p.name}')">Ù‡Ø¬ÙˆÙ…</button>
            `;
            container.appendChild(div);
        });
    });
</script>

</body>
</html>
