<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù†Ø®Ø¨Ø© Ø§Ù„Ù…Ø­Ø§Ø±Ø¨ÙŠÙ† - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</title>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>
    <style>
        :root { --bg: #0d1117; --gold: #f1c40f; --shield: #3498db; --danger: #e74c3c; --panel: #161b22; --accent: #2ecc71; }
        
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: white; margin: 0; overflow: hidden; display: flex; height: 100vh; width: 100vw; }

        /* Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        aside { width: 220px; background: var(--panel); border: 1px solid #30363d; display: flex; flex-direction: column; padding: 10px; box-sizing: border-box; }
        
        main#gameArea { flex-grow: 1; position: relative; background: #010409; overflow: hidden; touch-action: none; background-image: radial-gradient(#30363d 1px, transparent 1px); background-size: 40px 40px; }

        .stat-card { background: #0d1117; padding: 10px; border-radius: 8px; margin-bottom: 8px; text-align: center; border: 1px solid #30363d; }
        .stat-card small { color: #8b949e; font-size: 0.7rem; display: block; }
        .stat-card span { color: var(--gold); font-size: 1.1rem; font-weight: bold; }

        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† */
        #myIdentity { background: #1f2937; padding: 8px; border-radius: 6px; margin-bottom: 10px; border: 1px solid var(--accent); text-align: center; }
        #playersContainer { flex-grow: 1; overflow-y: auto; }
        .player-row { background: #21262d; margin-bottom: 6px; padding: 8px; border-radius: 6px; position: relative; border-right: 4px solid transparent; }
        .top-rank { border-right-color: var(--gold); }
        .rank-num { position: absolute; left: 8px; top: 50%; transform: translateY(-50%); font-weight: bold; color: var(--gold); }
        .player-info { margin-right: 25px; display: flex; flex-direction: column; font-size: 0.8rem; }
        
        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn { border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .attack-btn { background: var(--danger); color: white; padding: 6px; width: 100%; margin-top: 5px; font-size: 0.75rem; }
        .attack-btn:disabled { background: #2d333b; color: #484f58; cursor: not-allowed; }
        .shield-btn { background: var(--shield); color: white; padding: 12px; margin-top: auto; }
        .shield-btn:disabled { background: #2d333b; opacity: 0.6; }

        /* Ø§Ù„Ù†ÙˆØ§ÙØ° */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: var(--panel); padding: 25px; border-radius: 12px; border: 1px solid #30363d; max-width: 350px; text-align: center; }
        
        /* Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ */
        .resource { width: 42px; height: 42px; position: absolute; border-radius: 50%; background: var(--gold); box-shadow: 0 0 15px var(--gold); display: flex; align-items: center; justify-content: center; font-size: 1.3rem; cursor: pointer; z-index: 10; }
    </style>
</head>
<body>

<div id="loginOverlay" class="overlay" style="display: flex;">
    <div class="modal">
        <h2>âš”ï¸ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>
        <input type="text" id="usernameInput" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§..." style="width: 100%; padding: 10px; margin: 15px 0; background: #0d1117; border: 1px solid #30363d; color: white;">
        <button class="btn shield-btn" style="width: 100%;" onclick="initPlayer()">Ø¯Ø®ÙˆÙ„ / ØªØ³Ø¬ÙŠÙ„</button>
    </div>
</div>

<aside>
    <div class="stat-card"><small>Ø§Ù„Ø°Ù‡Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ</small><span id="myScore">0</span></div>
    <div class="stat-card"><small>ÙˆÙ‚Øª Ø§Ù„Ø¯Ø±Ø¹</small><span id="shieldText">ØºÙŠØ± Ù†Ø´Ø·</span></div>
    <div class="stat-card"><small>Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù‡Ø¬ÙˆÙ…</small><span id="cooldown">Ø¬Ø§Ù‡Ø²</span></div>
    <button id="mainShieldBtn" class="btn shield-btn" onclick="buyShield()">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¹ (100 ğŸ’°)</button>
</aside>

<main id="gameArea"></main>

<aside>
    <div id="myIdentity">ğŸ‘¤ <b id="displayMyName">...</b> (Ø£Ù†Øª)</div>
    <h4 style="margin: 0 0 10px 0; text-align: center; font-size: 0.9rem;">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø±Ø¨ÙŠÙ† ğŸ†</h4>
    <div id="playersContainer"></div>
</aside>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAbYbcjdLAEfqIPyrdHq1ZIqjqumDVjhmI",
        authDomain: "barqnet-2a561.firebaseapp.com",
        databaseURL: "https://barqnet-2a561-default-rtdb.firebaseio.com",
        projectId: "barqnet-2a561",
        storageBucket: "barqnet-2a561.firebasestorage.app",
        messagingSenderId: "53556699186",
        appId: "1:53556699186:web:c9e2b60d81979c18841c2b"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let playerName, playerRef, myLocalScore = 0, attackCooldown = 0, isShieldActive = false;

    function initPlayer() {
        const input = document.getElementById('usernameInput').value.trim();
        if (!input) return alert("Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨!");
        playerName = input;
        document.getElementById('displayMyName').textContent = playerName;
        playerRef = db.ref('players/' + playerName);

        playerRef.get().then(snap => {
            if (!snap.exists()) playerRef.set({ name: playerName, score: 0, shieldUntil: 0 });
            document.getElementById('loginOverlay').style.display = 'none';
            startSync();
        });
    }

    function startSync() {
        // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§ØªÙŠ ÙˆÙ…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
        playerRef.on('value', snap => {
            const d = snap.val();
            if (d) {
                myLocalScore = d.score || 0;
                document.getElementById('myScore').textContent = myLocalScore;
                
                const now = Date.now();
                if (d.shieldUntil > now) {
                    isShieldActive = true;
                    document.getElementById('mainShieldBtn').disabled = true;
                    const rem = Math.ceil((d.shieldUntil - now) / 1000);
                    document.getElementById('shieldText').textContent = Math.floor(rem/60) + ":" + (rem%60).toString().padStart(2,'0');
                } else {
                    isShieldActive = false;
                    document.getElementById('mainShieldBtn').disabled = false;
                    document.getElementById('shieldText').textContent = "ØºÙŠØ± Ù†Ø´Ø·";
                }
            }
        });

        // Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ ÙˆØ§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
        db.ref('map').on('child_added', snap => {
            const d = snap.val();
            const res = document.createElement('div');
            res.className = 'resource'; res.id = snap.key; res.innerHTML = 'ğŸ’°';
            res.style.left = d.x + "%"; res.style.top = d.y + "%";
            res.onclick = () => {
                playerRef.child('score').transaction(s => (s || 0) + 15);
                db.ref('map/' + snap.key).remove();
            };
            document.getElementById('gameArea').appendChild(res);
        });

        db.ref('map').on('child_removed', snap => {
            const el = document.getElementById(snap.key);
            if (el) el.remove();
        });

        // Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©
        db.ref('players').orderByChild('score').on('value', snap => {
            const cont = document.getElementById('playersContainer');
            cont.innerHTML = '';
            let list = [];
            snap.forEach(c => { list.push({key: c.key, ...c.val()}); });
            list.reverse().forEach((p, i) => {
                if (p.key === playerName) return;
                const rank = i + 1;
                const isS = p.shieldUntil > Date.now();
                const div = document.createElement('div');
                div.className = `player-row ${rank <= 5 ? 'top-rank' : ''}`;
                div.innerHTML = `
                    ${rank <= 5 ? `<div class="rank-num">${rank}</div>` : ''}
                    <div class="player-info">
                        <strong>${p.name || p.key}</strong>
                        <span>ğŸ’° ${p.score || 0}</span>
                    </div>
                    <button class="btn attack-btn" ${isS || attackCooldown > 0 ? 'disabled' : ''} 
                        onclick="attackPlayer('${p.key}')">${isS ? 'Ù…Ø­Ù…ÙŠ ğŸ›¡ï¸' : 'Ù‡Ø¬ÙˆÙ… âš”ï¸'}</button>
                `;
                cont.appendChild(div);
            });
        });
    }

    function attackPlayer(tName) {
        if (attackCooldown > 0) return;
        attackCooldown = 600; // Ù…Ù†Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…ØªÙƒØ±Ø± ÙÙˆØ±Ø§Ù‹
        startCooldownTimer();

        const tRef = db.ref('players/' + tName);
        tRef.get().then(snap => {
            const t = snap.val();
            if (t.shieldUntil > Date.now()) return alert("Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙØ¹Ù„ Ø§Ù„Ø¯Ø±Ø¹ Ù„Ù„ØªÙˆ!");
            
            if (t.score > myLocalScore) {
                playerRef.child('score').transaction(s => Math.max(0, s - 30));
                tRef.child('score').transaction(s => (s || 0) + 30);
                alert("Ø®Ø³Ø±Øª 30 Ø°Ù‡Ø¨ Ù„ØµØ§Ù„Ø­ " + tName);
            } else {
                const loot = Math.floor(t.score * 0.2);
                playerRef.child('score').transaction(s => (s || 0) + loot);
                tRef.child('score').transaction(s => Math.max(0, s - loot));
                alert("Ù†Ø¬Ø­ Ø§Ù„Ù‡Ø¬ÙˆÙ…! Ù†Ù‡Ø¨Øª " + loot + " Ø°Ù‡Ø¨.");
            }
        });
    }

    function startCooldownTimer() {
        const itv = setInterval(() => {
            if (attackCooldown > 0) {
                attackCooldown--;
                document.getElementById('cooldown').textContent = Math.floor(attackCooldown/60) + ":" + (attackCooldown%60).toString().padStart(2,'0');
            } else {
                document.getElementById('cooldown').textContent = "Ø¬Ø§Ù‡Ø²";
                clearInterval(itv);
            }
        }, 1000);
    }

    function buyShield() {
        if (isShieldActive) return; // Ù…Ù†Ø¹ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù†Ø´Ø·Ø§Ù‹
        if (myLocalScore >= 100) {
            playerRef.child('score').transaction(s => s - 100);
            playerRef.child('shieldUntil').set(Date.now() + 600000);
        } else {
            alert("Ø°Ù‡Ø¨ ØºÙŠØ± ÙƒØ§ÙÙ!");
        }
    }

    // ØªÙˆÙ„ÙŠØ¯ Ø°Ù‡Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ
    setInterval(() => {
        db.ref('map').once('value', snap => {
            if (snap.numChildren() < 12) db.ref('map').push({ x: Math.random()*90+5, y: Math.random()*85+5 });
        });
    }, 4000);
</script>
</body>
</html>
